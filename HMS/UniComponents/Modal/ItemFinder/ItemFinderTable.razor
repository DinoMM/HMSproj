@namespace UniComponents
@inject IJSRuntime JSRuntime
@implements IModal

@typeparam T where T : class

<div class="modal fade" id="@ID" data-bs-backdrop="static" data-bs-keyboard="false" tabindex="-1" aria-labelledby="staticBackdropLabel" aria-hidden="true" @onkeydown="HandleKeyDown">
    <div class="modal-dialog modal-lg" style="max-width:100rem">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="staticBackdropLabel">

                    <div class="col-12 d-flex justify-content-bottom mb-1">
                        <SearchInput @ref="srchinp" NumCols="@NumCols" PlaceHolder="Vyhľadaj..." TableID="@IDTable" SearchValue="@SearchedValue"></SearchInput>
                    </div>

                </h5>
            </div>
            <div class="modal-body" id="modalATextxLabel">

                <div class="col-12" style="max-height: 30rem;overflow: auto;">
                    <SimpleTable ID="@IDTable">
                        <THEAD>

                            @foreach (var item in ColNames)
                            {
                            <th class="col-resize" scope="col">@item</th>
                        }
                            </THEAD>
                            <TBODY>

                                @foreach (var item in ColValues)
                                {

                                    <tr @onclick=@(() => SelectRow(item)) @ondblclick="@(() => SelectDbClick(item))" class="@(ContainsRow(item) ?   "selected-row" : "")" style="cursor: pointer;">
                                        @foreach (var ytem in GetProperties(item))
                                        {
                                            <td class="col-resize">@ytem.GetValue(item)</td>
                                        }
                                    </tr>
                                }

                                <span id="observerTarget"></span>
                            </TBODY>

                        </SimpleTable>
                    </div>

                </div>

                <div class="modal-footer">
                    @if (SelectEmptyInstance)
                    {
                        <button type="button" class="btn btn-warning" data-bs-dismiss="modal" @onclick="EmptyInstance">Vyčistiť</button>
                    }
                    <button type="button" class="btn btn-primary" data-bs-dismiss="modal" disabled="@(OutSelection.Count == 0)" @onclick=@(() =>  CloseModal(true))>Vyber</button>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" @onclick=@(() => CloseModal(false))>Zruš</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        window.setInput = function (inputId, invalue) {
            document.getElementById(inputId).value = invalue;
        }
    function getInputValue(inputId) {
    return document.getElementById(inputId).value;
}
    </script>

    @code {
        private SearchInput srchinp = new();

        /// <summary>
        /// Unikatne ID podla ktoreho vieme rozoznat medzi viacerymi modalmi
        /// </summary>
        [Parameter]
        public string ID { get; set; } = "staticItemFinderTable";

        /// <summary>
        /// Názvy stĺpcov tabuľky v poradí, v akom sa majú zobrazovať
        /// </summary>
        [Parameter]
        public List<string> ColNames { get; set; } = new();

        /// <summary>
        /// Hodnoty stĺpcov tabuľky typu T, hodnoty idu podľa poradia a vynechávaju sa foreign keys
        /// </summary>
        [Parameter]
        public List<T> ColValues { get; set; } = new();

        /// <summary>
        /// Hodnota, ktorá sa má vyhľadávať v tabuľke
        /// </summary>
        [Parameter]
        public string SearchedValue { get; set; } = "";

        /// <summary>
        ///Viac násobný výber z tabuľky, default false
        /// </summary>
        [Parameter]
        public bool MultiSelect { get; set; } = false;

        /// <summary>
        /// Vybrané hodnoty z tabuľky, spracuj po tom čo sa zavrie modal
        /// </summary>
        [Parameter]
        public List<T> OutSelection { get; set; } = new();

        #region Attribute settings
        /// <summary>
        ///Pridať aj parametre s primárnými klúčmi, default false
        /// </summary>
        [Parameter]
        public bool KeyAttributeToo { get; set; } = false;

        /// <summary>
        ///Pridať aj parametre s cudzími klúčmi, default false
        /// </summary>
        [Parameter]
        public bool ForeignAttributesToo { get; set; } = false;

        /// <summary>
        ///Pridať aj parametre ktoré sú brané bez mapovania, default false
        /// </summary>
        [Parameter]
        public bool NotMappedAttributesToo { get; set; } = false;

        /// <summary>
        ///Pridať len parametre, ktoré sú označené ProtectedPersonalData, default false
        /// </summary>
        [Parameter]
        public bool OnlyProtectedPersonalDataAttribute { get; set; } = false;
        #endregion
        /// <summary>
        ///Pridať možnosť vypratia prázneho výberu, default false
        /// </summary>
        [Parameter]
        public bool SelectEmptyInstance { get; set; } = false;

        private string IDTable { get => "tableid" + ID; }
        private int NumCols { get => ColNames.Count; }

        private TaskCompletionSource<bool> tcs;
        private bool tstop = false;

        /// <summary>
        ///  Otvori modal pod ulozenym ID, vracia hodnotu podla toho, ci uzivatel klikol ano alebo nie
        /// </summary>
        /// <param name="stop"> Vrati true ak uzivatel prijal, inak false</param>
        /// <returns></returns>
        public async Task<bool> OpenModal(bool stop = false)
        {
            StateHasChanged();
            await srchinp.Forcesearch();

            tstop = stop;
            if (stop)
            {
                tcs = new TaskCompletionSource<bool>();
                await JSRuntime.InvokeVoidAsync("eval", "$('#" + ID + "').modal('show');");  //(pomohol som si z internetu tutoriály/AI)
                await tcs.Task;             //fyzické statie programu
                return tcs.Task.Result;
            }
            else
            {
                await JSRuntime.InvokeVoidAsync("eval", "$('#" + ID + "').modal('show');");  //(pomohol som si z internetu tutoriály/AI)
                return true;
            }

        }

        private void CloseModal(bool ans)
        {
            if (!ans)
            {
                OutSelection.Clear();
            }

            if (tstop)
            {
                tcs.SetResult(ans); //zastavi fyzické státie programu
            }
            JSRuntime.InvokeVoidAsync("eval", "$('#" + ID + "').modal('hide');"); //(pomohol som si z internetu tutoriály/AI)
        }

        public void UpdateText(string newText) { }

        private async Task HandleKeyDown(KeyboardEventArgs e)
        {
            if (e.Key == "Enter")       //po stlaceni enteru sa vykona akcia Ano
            {
                if (OutSelection.Count != 0)
                {
                    CloseModal(true);
                }
            }
            if (e.Key == "Escape")       //po stlaceni escape sa vykona akcia Nie
            {
                CloseModal(false);
            }
        }

        public async Task PassSearchText(string text)
        {
            SearchedValue = text;
        }

        private System.Reflection.PropertyInfo[] GetProperties(object obj)
        {
            var prop = obj.GetType().GetProperties();
            var propRet = new List<System.Reflection.PropertyInfo>();
            foreach (var item in prop)
            {
                if (!ForeignAttributesToo)
                {
                    if (item.GetCustomAttributes(typeof(System.ComponentModel.DataAnnotations.Schema.ForeignKeyAttribute), false).FirstOrDefault() != null)
                    {
                        continue;
                    }
                }

                if (!KeyAttributeToo)
                {
                    if (item.GetCustomAttributes(typeof(System.ComponentModel.DataAnnotations.KeyAttribute), false).FirstOrDefault() != null)
                    {
                        continue;
                    }
                }

                if (!NotMappedAttributesToo)
                {
                    if (item.GetCustomAttributes(typeof(System.ComponentModel.DataAnnotations.Schema.NotMappedAttribute), false).FirstOrDefault() != null)
                    {
                        continue;
                    }
                }
                if (OnlyProtectedPersonalDataAttribute)
                {
                    if (item.GetCustomAttributes(typeof(Microsoft.AspNetCore.Identity.ProtectedPersonalDataAttribute), false).FirstOrDefault() != null)
                    {
                        propRet.Add(item);
                    }
                    continue;
                }

                var propType = item.PropertyType;
                if (propType == typeof(string) || propType == typeof(int) || propType == typeof(bool) || propType == typeof(double) || propType == typeof(DateTime) || propType.IsEnum)
                {
                    propRet.Add(item);
                    continue;
                }
            }
            return propRet.ToArray();
        }

        private void SelectRow(object item)
        {
            if (MultiSelect)
            {
                if (OutSelection.Contains(item))
                {
                    OutSelection.Remove((T)item);
                }
                else
                {
                    OutSelection.Add((T)item);
                }
            }
            else
            {
                OutSelection.Clear();
                OutSelection.Add((T)item);
            }
        }

        private void SelectDbClick(object item)
        {
            if (!MultiSelect)
            {
                OutSelection.Clear();
                OutSelection.Add((T)item);
                CloseModal(true);
            }
        }

        private bool ContainsRow(object item)
        {
            return OutSelection.Contains((T)item);
        }

        /// <summary>
        /// Vráti hodnotu z inputu podla jeho ID
        /// </summary>
        /// <param name="id"></param>
        /// <returns></returns>
        public async Task<string> GetInputValue(string id)
        {
            return await JSRuntime.InvokeAsync<string>("getInputValue", id);
        }

        /// <summary>
        /// Nastavi input na hodnotu podla jeho ID
        /// </summary>
        /// <param name="id"></param>
        /// <returns></returns>
        public async Task SetInput(string id, string text)
        {
            await JSRuntime.InvokeVoidAsync("setInput", id, text);
        }

        public void EmptyInstance()
        {
            OutSelection.Clear();
            OutSelection.Add(Activator.CreateInstance<T>());
            CloseModal(true);
        }

    }
